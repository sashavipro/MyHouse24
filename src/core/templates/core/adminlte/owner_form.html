{% extends 'core/adminlte/admin_layout.html' %}

{% load static %}

{% block title %}
  {{ page_title|default:"Форма Владельца" }}
{% endblock title %}
{% block content %}
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>{{ page_title|default:"Форма Владельца" }}</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item">
              <a href="#">Главная</a>
            </li>
            <li class="breadcrumb-item">
              <a href="{% url 'users:owner_list' %}">Владельцы</a>
            </li>
            <li class="breadcrumb-item active">{{ page_title }}</li>
          </ol>
        </div>
      </div>
    </div>
  </section>
  <section class="content">
    <div class="container-fluid">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="card card-primary card-outline">
          <div class="card-body">
            {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
            <div class="row">
              <!-- Левая колонка -->
              <div class="col-md-8">
                <div class="row">
                  <div class="col-md-4 text-center">
                    <div class="mb-3">
                      {% if owner_obj.avatar %}
                        <img id="avatar-preview"
                             src="{{ owner_obj.avatar.url }}"
                             alt="Avatar"
                             class="img-fluid rounded-circle avatar-placeholder" />
                      {% else %}
                        <div id="avatar-preview" class="bi bi-image text-muted avatar-placeholder"></div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.avatar.id_for_label }}" class="form-label">{{ form.avatar.label }}</label>
                      {{ form.avatar }}
                      {% if form.avatar.errors %}<div class="text-danger small mt-1">{{ form.avatar.errors }}</div>{% endif %}
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }}</label>
                      {{ form.last_name }}
                      {% if form.last_name.errors %}<div class="text-danger small mt-1">{{ form.last_name.errors }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }}</label>
                      {{ form.first_name }}
                      {% if form.first_name.errors %}<div class="text-danger small mt-1">{{ form.first_name.errors }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.middle_name.id_for_label }}">{{ form.middle_name.label }}</label>
                      {{ form.middle_name }}
                      {% if form.middle_name.errors %}<div class="text-danger small mt-1">{{ form.middle_name.errors }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.birthday.id_for_label }}">{{ form.birthday.label }}</label>
                      {{ form.birthday }}
                      {% if form.birthday.errors %}<div class="text-danger small mt-1">{{ form.birthday.errors }}</div>{% endif %}
                    </div>
                  </div>
                </div>
                <hr />
                <h5>Контактные данные</h5>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.phone.id_for_label }}">{{ form.phone.label }}</label>
                    {{ form.phone }}
                    {% if form.phone.errors %}<div class="text-danger small mt-1">{{ form.phone.errors }}</div>{% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.viber.id_for_label }}">Viber</label>
                    {{ form.viber }}
                    {% if form.viber.errors %}<div class="text-danger small mt-1">{{ form.viber.errors }}</div>{% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.telegram.id_for_label }}">Telegram</label>
                    {{ form.telegram }}
                    {% if form.telegram.errors %}<div class="text-danger small mt-1">{{ form.telegram.errors }}</div>{% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                    {{ form.email }}
                    {% if form.email.errors %}<div class="text-danger small mt-1">{{ form.email.errors }}</div>{% endif %}
                  </div>
                </div>
              </div>
              <!-- Правая колонка -->
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
                  {{ form.status }}
                  {% if form.status.errors %}<div class="text-danger small mt-1">{{ form.status.errors }}</div>{% endif %}
                </div>
                <div class="mb-3">
                  <label for="{{ form.owner_id.id_for_label }}">{{ form.owner_id.label }}</label>
                  {{ form.owner_id }}
                  {% if form.owner_id.errors %}<div class="text-danger small mt-1">{{ form.owner_id.errors }}</div>{% endif %}
                </div>
                <div class="mb-3">
                  <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                  {{ form.description }}
                  {% if form.description.errors %}<div class="text-danger small mt-1">{{ form.description.errors }}</div>{% endif %}
                </div>
                <hr />
                <h5>Изменить пароль</h5>
                <div class="mb-3">
                  <label for="{{ form.password.id_for_label }}">{{ form.password.label }}</label>
                  <div class="input-group">
                    {{ form.password }}
                    <button class="btn btn-outline-secondary"
                            type="button"
                            id="generate-password">Сгенерировать</button>
                    <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  {% if form.password.errors %}<div class="text-danger small mt-1">{{ form.password.errors }}</div>{% endif %}
                </div>
                <div class="mb-3">
                  <label for="{{ form.password2.id_for_label }}">{{ form.password2.label }}</label>
                  {{ form.password2 }}
                  {% if form.password2.errors %}<div class="text-danger small mt-1">{{ form.password2.errors }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer text-end">
            <a href="{% url 'users:owner_list' %}" class="btn btn-secondary">Отменить</a>
            <button type="submit" class="btn btn-success">Сохранить</button>
          </div>
        </div>
      </form>
    </div>
  </section>
{% endblock content %}
{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Preview for avatar
      const avatarInput = document.getElementById('{{ form.avatar.id_for_label }}');
      const avatarPreview = document.getElementById('avatar-preview');
      avatarInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            avatarPreview.src = e.target.result;
          }
          reader.readAsDataURL(file);
        }
      });

      // Password generator and toggle
      const passwordInput = document.getElementById('{{ form.password.id_for_label }}');
      const password2Input = document.getElementById('{{ form.password2.id_for_label }}');
      const generateBtn = document.getElementById('generate-password');
      const toggleBtn = document.getElementById('toggle-password');

      generateBtn.addEventListener('click', function() {
        const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()";
        let newPassword = "";
        for (let i = 0, n = charset.length; i < 12; ++i) {
          newPassword += charset.charAt(Math.floor(Math.random() * n));
        }
        passwordInput.value = newPassword;
        password2Input.value = newPassword;
      });

      toggleBtn.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.querySelector('i').classList.toggle('bi-eye');
        this.querySelector('i').classList.toggle('bi-eye-slash');
      });
    });
  </script>
  <style>
    .avatar-placeholder {
      width: 150px;
      height: 150px;
      object-fit: cover;
    }

    #avatar-preview.bi-image {
      font-size: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
{% endblock scripts %}
