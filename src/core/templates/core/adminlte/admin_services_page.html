{% extends 'core/adminlte/admin_layout.html' %}

{% load static %}

{% block title %}
  Редактирование страницы "Услуги"
{% endblock title %}
{% block content %}
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Редактирование страницы "Услуги"</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item">
              <a href="{% url 'finance:admin_stats' %}">Главная</a>
            </li>
            <li class="breadcrumb-item active">Редактирование Услуг</li>
          </ol>
        </div>
      </div>
    </div>
  </section>
  <section class="content">
    <div class="container-fluid">
      <form action="{% url 'website:admin_services' %}"
            method="post"
            enctype="multipart/form-data">
        {% csrf_token %}
        <div class="card card-primary card-outline">
          <div class="card-header">
            <h3 class="card-title">Редактирование страницы "Услуги"</h3>
          </div>
          <div class="card-body">
            <h3 class="page-header">Услуги</h3>
            {{ formset.management_form }}
            <div class="row" id="service-forms-container">
              {% for form in formset %}
                <div class="col-md-4 service-form-item mb-4"
                     id="service-form-container-{{ forloop.counter0 }}">
                  {{ form.id }}
                  <h4 class="d-flex justify-content-between align-items-center">
                    <span>Услуга {{ forloop.counter }}</span>
                    {% if form.instance.pk %}
                      <div class="d-none">{{ form.DELETE }}</div>
                      <button type="button"
                              class="btn btn-link text-danger p-0 delete-service-btn"
                              title="Отметить для удаления">
                        <i class="bi bi-trash"></i>
                      </button>
                    {% endif %}
                  </h4>
                  {% if form.instance.image %}
                    <img src="{{ form.instance.image.url }}"
                         alt="Превью"
                         class="img-fluid rounded mb-3" />
                  {% endif %}
                  <div class="mb-3">
                    <label for="{{ form.image.id_for_label }}">Рекомендуемый размер: (650x300)</label>
                    {{ form.image }}{{ form.image.errors }}
                  </div>
                  <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}">Название услуги</label>
                    {{ form.title }}{{ form.title.errors }}
                  </div>
                  <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}">Описание услуги</label>
                    {{ form.description }}{{ form.description.errors }}
                  </div>
                </div>
              {% endfor %}
            </div>
            <template id="empty-form-template">
              <div class="col-md-4 service-form-item mb-4">
                {{ formset.empty_form.id }}
                <h4 class="d-flex justify-content-between align-items-center">
                  <span class="new-form-title">Новая услуга</span>
                  <button type="button"
                          class="btn btn-link text-danger p-0 delete-service-btn"
                          title="Удалить">
                    <i class="bi bi-trash"></i>
                  </button>
                </h4>
                <div class="mb-3">
                  <label for="id_{{ formset.prefix }}-__prefix__-image">Рекомендуемый размер: (650x300)</label>
                  {{ formset.empty_form.image }}
                </div>
                <div class="mb-3">
                  <label for="id_{{ formset.prefix }}-__prefix__-title">Название услуги</label>
                  {{ formset.empty_form.title }}
                </div>
                <div class="mb-3">
                  <label for="id_{{ formset.prefix }}-__prefix__-description">Описание услуги</label>
                  {{ formset.empty_form.description }}
                </div>
              </div>
            </template>
            <h3 class="page-header mt-4">Настройки SEO</h3>
            <div class="mb-3">
              <label class="form-label" for="{{ form.title.id_for_label }}">Title</label>
              {{ form.title }}{{ form.title.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label" for="{{ form.description.id_for_label }}">Description</label>
              {{ form.description }}{{ form.description.errors }}
            </div>
            <div class="mb-3">
              <label class="form-label" for="{{ form.keywords.id_for_label }}">Keywords</label>
              {{ form.keywords }}{{ form.keywords.errors }}
            </div>
          </div>
          <div class="card-footer text-center">
            <a href="{% url 'website:admin_services' %}" class="btn btn-secondary">Отменить</a>
            <button type="button" id="add-service-form-btn" class="btn btn-success">Добавить услугу</button>
            <button type="submit" class="btn btn-success">Сохранить</button>
          </div>
        </div>
      </form>
    </div>
  </section>
{% endblock content %}
{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const formsContainer = document.getElementById('service-forms-container');
      const addServiceBtn = document.getElementById('add-service-form-btn'); // <-- Получаем кнопку
      const formsetPrefix = '{{ formset.prefix }}';

      // Функция для обработки кнопок удаления (работает для существующих и новых кнопок)
      const handleDeleteClick = (event) => {
        const deleteBtn = event.target.closest('.delete-service-btn');
        if (!deleteBtn) return; // Выходим, если клик был не по кнопке удаления

        const formItem = deleteBtn.closest('.service-form-item');
        const deleteCheckbox = formItem.querySelector('input[type=checkbox][name$="-DELETE"]');

        if (deleteCheckbox) {
          // Это существующая форма: отмечаем на удаление и скрываем
          deleteCheckbox.checked = true;
          formItem.style.display = 'none';
        } else {
          // Это новая форма: просто удаляем из DOM
          formItem.remove();
        }
      };

      // Вешаем один обработчик на весь контейнер (делегирование событий)
      formsContainer.addEventListener('click', handleDeleteClick);

      // Логика добавления новой формы
      addServiceBtn.addEventListener('click', function() {
        const template = document.getElementById('empty-form-template');
        const totalFormsInput = document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`);
        let formIdx = parseInt(totalFormsInput.value);

        const newFormNode = template.content.cloneNode(true).firstElementChild;
        newFormNode.innerHTML = newFormNode.innerHTML.replace(/__prefix__/g, formIdx);
        newFormNode.querySelector('.new-form-title').textContent = `Новая услуга ${formIdx + 1}`;

        formsContainer.appendChild(newFormNode);
        totalFormsInput.value = formIdx + 1;

        // Инициализируем TinyMCE для нового поля
        const newTextareaId = `id_${formsetPrefix}-${formIdx}-description`;
        if (tinymce.get(newTextareaId)) {
          tinymce.get(newTextareaId).remove();
        }
        tinymce.init({
          selector: `#${newTextareaId}`,
          plugins: 'code table lists link',
          toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist',
          height: 250,
          menubar: false,
          setup: function(editor) {
            editor.on('init change', function() {
              editor.save();
            });
          }
        });
      });
    });
  </script>
{% endblock scripts %}
