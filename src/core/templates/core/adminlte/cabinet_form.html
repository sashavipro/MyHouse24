{% extends 'core/adminlte/cabinet_layout.html' %}

{% load static %}

{% block title %}
  Редактирование профиля
{% endblock title %}
{% block styles %}
  {{ block.super }}
  <style>
    .avatar-placeholder {
      width: 150px;
      height: 150px;
      object-fit: cover;
    }

    .avatar-placeholder-icon {
      font-size: 150px;
    }
  </style>
{% endblock styles %}
{% block content %}
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Редактирование профиля</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item">
              <a href="{% url 'users:cabinet' %}">Профиль</a>
            </li>
            <li class="breadcrumb-item active">Редактирование</li>
          </ol>
        </div>
      </div>
    </div>
  </section>
  <section class="content">
    <div class="container-fluid">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
          <!-- Левая колонка -->
          <div class="col-lg-8">
            <div class="card card-primary card-outline">
              <div class="card-header">
                <h3 class="card-title">Личные данные</h3>
              </div>
              <div class="card-body">
                {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
                <div class="row">
                  <!-- Блок аватара -->
                  <div class="col-md-4 text-center">
                    <div class="mb-3">
                      {% if form.instance.avatar %}
                        <img id="avatar-preview"
                             src="{{ form.instance.avatar.url }}"
                             alt="Avatar"
                             class="img-fluid rounded-circle avatar-placeholder" />
                      {% else %}
                        <div class="d-flex align-items-center justify-content-center">
                          <i id="avatar-preview-icon"
                             class="bi bi-person-circle text-muted avatar-placeholder-icon"></i>
                          <img id="avatar-preview-img"
                               src="#"
                               alt="Avatar"
                               class="img-fluid rounded-circle avatar-placeholder d-none" />
                        </div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.avatar.id_for_label }}" class="form-label">Сменить изображение</label>
                      {{ form.avatar }}
                      {% if form.avatar.errors %}<div class="text-danger small mt-1">{{ form.avatar.errors }}</div>{% endif %}
                    </div>
                  </div>
                  <!-- Блок ФИО и даты рождения -->
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="{{ form.last_name.id_for_label }}" class="form-label">Фамилия</label>
                      {{ form.last_name }}
                      {% if form.last_name.errors %}<div class="text-danger small mt-1">{{ form.last_name.errors }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.first_name.id_for_label }}" class="form-label">Имя</label>
                      {{ form.first_name }}
                      {% if form.first_name.errors %}<div class="text-danger small mt-1">{{ form.first_name.errors }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.middle_name.id_for_label }}" class="form-label">Отчество</label>
                      {{ form.middle_name }}
                      {% if form.middle_name.errors %}<div class="text-danger small mt-1">{{ form.middle_name.errors }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                      <label for="{{ form.birthday.id_for_label }}" class="form-label">Дата рождения</label>
                      {{ form.birthday }}
                      {% if form.birthday.errors %}<div class="text-danger small mt-1">{{ form.birthday.errors }}</div>{% endif %}
                    </div>
                  </div>
                </div>
                <hr />
                <h5 class="mt-4">Контактные данные</h5>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.phone.id_for_label }}" class="form-label">Телефон</label>
                    {{ form.phone }}
                    {% if form.phone.errors %}<div class="text-danger small mt-1">{{ form.phone.errors }}</div>{% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.viber.id_for_label }}" class="form-label">Viber</label>
                    {{ form.viber }}
                    {% if form.viber.errors %}<div class="text-danger small mt-1">{{ form.viber.errors }}</div>{% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.telegram.id_for_label }}" class="form-label">Telegram</label>
                    {{ form.telegram }}
                    {% if form.telegram.errors %}<div class="text-danger small mt-1">{{ form.telegram.errors }}</div>{% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label">Email (логин)</label>
                    {{ form.email }}
                    {% if form.email.errors %}<div class="text-danger small mt-1">{{ form.email.errors }}</div>{% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Правая колонка -->
          <div class="col-lg-4">
            <div class="card">
              <div class="card-body">
                <div class="mb-3">
                  <label for="{{ form.owner_id.id_for_label }}" class="form-label">{{ form.owner_id.label }}</label>
                  {{ form.owner_id }}
                  {% if form.owner_id.errors %}<div class="text-danger small mt-1">{{ form.owner_id.errors }}</div>{% endif %}
                </div>
                <div class="mb-3">
                  <label for="{{ form.description.id_for_label }}" class="form-label">Обо мне (заметки)</label>
                  {{ form.description }}
                  {% if form.description.errors %}<div class="text-danger small mt-1">{{ form.description.errors }}</div>{% endif %}
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Изменить пароль</h3>
              </div>
              <div class="card-body">
                <p class="text-muted small">Оставьте поля пустыми, если не хотите менять пароль.</p>
                <div class="mb-3">
                  <label for="{{ form.password.id_for_label }}" class="form-label">{{ form.password.label }}</label>
                  <div class="input-group">
                    {{ form.password }}
                    <button class="btn btn-outline-secondary"
                            type="button"
                            id="generate-password">Сгенерировать</button>
                    <button class="btn btn-outline-secondary"
                            type="button"
                            id="toggle-password"
                            title="Показать/скрыть пароль">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  {% if form.password.errors %}<div class="text-danger small mt-1">{{ form.password.errors }}</div>{% endif %}
                </div>
                <div class="mb-3">
                  <label for="{{ form.password2.id_for_label }}" class="form-label">{{ form.password2.label }}</label>
                  {{ form.password2 }}
                  {% if form.password2.errors %}<div class="text-danger small mt-1">{{ form.password2.errors }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Кнопки сохранения -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-body text-end">
                <a href="{% url 'users:cabinet' %}" class="btn btn-secondary">Отменить</a>
                <button type="submit" class="btn btn-success">Сохранить</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </section>
{% endblock content %}
{% block scripts %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- Логика предпросмотра аватара ---
      const avatarInput = document.getElementById('{{ form.avatar.id_for_label }}');
      const previewImg = document.getElementById('avatar-preview-img');
      const previewIcon = document.getElementById('avatar-preview-icon');
      const existingPreview = document.getElementById('avatar-preview');

      avatarInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            // Если был старый аватар, скрываем его
            if (existingPreview) existingPreview.classList.add('d-none');
            // Если была иконка, скрываем ее
            if (previewIcon) previewIcon.classList.add('d-none');
            // Показываем и устанавливаем новое изображение
            if (previewImg) {
              previewImg.src = e.target.result;
              previewImg.classList.remove('d-none');
            }
          }
          reader.readAsDataURL(file);
        }
      });

      // --- Логика для пароля ---
      const passwordInput = document.getElementById('{{ form.password.id_for_label }}');
      const password2Input = document.getElementById('{{ form.password2.id_for_label }}');
      const generateBtn = document.getElementById('generate-password');
      const toggleBtn = document.getElementById('toggle-password');

      // Генератор пароля
      generateBtn.addEventListener('click', function() {
        const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()";
        let newPassword = "";
        for (let i = 0, n = charset.length; i < 12; ++i) {
          newPassword += charset.charAt(Math.floor(Math.random() * n));
        }
        passwordInput.value = newPassword;
        password2Input.value = newPassword;
      });

      // Переключатель видимости пароля
      toggleBtn.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        password2Input.setAttribute('type', type);

        this.querySelector('i').classList.toggle('bi-eye');
        this.querySelector('i').classList.toggle('bi-eye-slash');
      });
    });
  </script>
{% endblock scripts %}
