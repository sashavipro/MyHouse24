{% extends 'core/adminlte/admin_layout.html' %}

{% load static %}

{% block title %}
  Тарифы
{% endblock title %}
{% block content %}
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Тарифы</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item">
              <a href="{% url 'finance:admin_stats' %}">Главная</a>
            </li>
            <li class="breadcrumb-item active">Тарифы</li>
          </ol>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-sm-12 text-end">
          <a href="{% url 'finance:tariff_add' %}" class="btn btn-success">Добавить тариф</a>
        </div>
      </div>
    </div>
  </section>
  <section class="content">
    <div class="card">
      <div class="card-body p-0">
        <div class="d-flex justify-content-end align-items-center p-3 border-bottom">
          <button type="button"
                  class="btn btn-outline-secondary"
                  id="clear-filters-btn">Очистить</button>
        </div>
        <div class="table-responsive">
          <table id="tariffs-table" class="table table-hover mb-0" width="100%">
            <thead>
              <tr>
                <th class="id-column">#</th>
                <th>Название тарифа</th>
                <th>Описание тарифа</th>
                <th>Дата редактирования</th>
                <th class="actions-column"></th>
              </tr>
              <tr class="filter-row">
                <td></td>
                <td>
                  <input type="text" id="filter_name" class="form-control form-control-sm" />
                </td>
                <td>
                  <input type="text"
                         id="filter_description"
                         class="form-control form-control-sm" />
                </td>
                <td></td>
                <td></td>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </section>
{% endblock content %}
{% block scripts %}
  {{ block.super }}
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet"
        href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css" />
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
  <script>
    $(document).ready(function() {
      const table = $('#tariffs-table').DataTable({
        serverSide: true,
        processing: true,
        searching: false,
        ordering: true,
        ajax: {
          url: "{% url 'finance:ajax_datatable_tariffs' %}",
          type: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data: function(d) {
            d.name = $('#filter_name').val();
            d.description = $('#filter_description').val();
          }
        },
        columns: [{
          data: 'pk',
          width: '50px'
        }, {
          data: 'name'
        }, {
          data: 'description'
        }, {
          data: 'updated_at'
        }, {
          data: 'actions',
          width: '120px'
        }],
        pageLength: 10,
        lengthMenu: [
          [10, 25, 50, 100],
          [10, 25, 50, 100]
        ],
        language: {
          /* ... (ваш код локализации) ... */
        },
        dom: '<"row"<"col-sm-12"tr>><"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
      });

      // Debounce для фильтров
      let debounceTimer;
      $('.filter-row input[type="text"]').on('keyup', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          table.ajax.reload();
        }, 500);
      });

      // Кнопка "Очистить"
      $('#clear-filters-btn').on('click', function() {
        $('.filter-row input').val('');
        table.ajax.reload();
      });

      // Удаление тарифа (RESTful)
      $(document).on('click', '.delete-tariff-btn', function(e) {
        e.stopPropagation();
        const id = $(this).data('id');
        const name = $(this).data('name');
        if (!confirm(`Вы уверены, что хотите удалить тариф "${name}"?`)) return;
        const deleteUrl = `/api/v1/finance/tariff/${id}`;
        $.ajax({
          url: deleteUrl,
          type: 'DELETE',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          statusCode: {
            200: function(response) {
              alert(response.message);
              table.ajax.reload(null, false);
            },
            400: function(xhr) {
              alert('Ошибка: ' + (xhr.responseJSON?.message || 'Неверный запрос'));
            },
            500: function(xhr) {
              alert('Внутренняя ошибка сервера: ' + (xhr.responseJSON?.message || 'Попробуйте позже'));
            }
          },
          error: function(xhr) {
            if (!xhr.responseJSON) {
              alert('Произошла сетевая ошибка или сервер недоступен.');
            }
          }
        });
      });

      // Клик по строке
      $('#tariffs-table tbody').on('click', 'tr', function(e) {
        if ($(e.target).closest('button, a').length > 0 || $(this).hasClass('filter-row')) return;
        const data = table.row(this).data();
        if (data && data.pk) {
          window.location.href = "{% url 'finance:tariff_detail' 0 %}".replace('0', data.pk);
        }
      });
    });
  </script>
  <style>
    .id-column {
      width: 50px;
    }

    .actions-column {
      width: 120px;
    }

    /* Убираем иконки сортировки */
    table.dataTable thead th::before,
    table.dataTable thead th::after,
    table.dataTable thead .dt-column-order {
      display: none !important;
    }

    table.dataTable thead th {
      cursor: default !important;
      padding-right: 12px !important;
      white-space: nowrap;
      /* заголовки в одну строку */
    }

    /* Курсор для строк */
    #tariffs-table tbody tr {
      cursor: pointer;
    }

    #tariffs-table tbody tr.filter-row {
      cursor: default;
    }

    /* Таблица без переноса текста */
    #tariffs-table td {
      white-space: nowrap !important;
      /* не переносим строки */
      overflow: hidden;
      text-overflow: ellipsis;
      /* добавляем "..." если текст не помещается */
      max-width: 250px;
      /* ограничиваем ширину ячеек */
      vertical-align: middle;
    }

    /* Делаем таблицу горизонтально скроллируемой */
    .table-responsive {
      overflow-x: auto;
    }

    /* Фильтр */
    .filter-row td {
      padding: 8px !important;
      background-color: #f8f9fa;
    }

    /* Кнопки и пагинация */
    .btn-sm {
      margin: 0 2px;
    }

    .pagination {
      margin-bottom: 0;
    }

    .page-link {
      padding: 0.375rem 0.75rem;
    }

    /* Поле поиска */
    .dataTables_filter {
      display: inline-block;
    }

    .dataTables_filter label {
      font-weight: normal;
      white-space: nowrap;
      text-align: left;
    }

    .dataTables_filter input {
      display: inline-block;
      width: auto;
      margin-left: 0.5em;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .dataTables_wrapper {
      width: 100%;
    }

    /* Кнопки действий */
    #tariffs-table .btn {
      margin: 0 1px;
      white-space: nowrap;
    }

    /* Центрируем контент */
    #tariffs-table th,
    #tariffs-table td {
      vertical-align: middle !important;
    }
  </style>
{% endblock scripts %}
