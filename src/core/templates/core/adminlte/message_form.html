{% extends 'core/adminlte/admin_layout.html' %}

{% load static %}

{% block title %}
  Новое сообщение
{% endblock title %}
{% block styles %}
  {{ block.super }}
  <style>
    .breadcrumb-transparent {
      background-color: transparent;
    }
  </style>
{% endblock styles %}
{% block content %}
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Новое сообщение</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end breadcrumb-transparent">
            <li class="breadcrumb-item">
              <a href="{% url 'finance:admin_stats' %}"><i class="bi bi-house-door"></i> Главная</a>
            </li>
            <li class="breadcrumb-item">
              <a href="{% url 'users:message_list' %}">Сообщения</a>
            </li>
            <li class="breadcrumb-item active">Новое сообщение</li>
          </ol>
        </div>
      </div>
    </div>
  </section>
  <section class="content">
    <div class="container-fluid">
      <form method="post" id="message-form">
        {% csrf_token %}
        <div class="card">
          <div class="card-body">
            {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
            <div class="mb-3">
              {{ form.title.label_tag }}
              {{ form.title }}
              {% if form.title.errors %}<div class="text-danger small mt-1">{{ form.title.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              {{ form.text.label_tag }}
              {{ form.text }}
              {% if form.text.errors %}<div class="text-danger small mt-1">{{ form.text.errors }}</div>{% endif %}
            </div>
            <hr />
            <h5>Кому отправить:</h5>
            <div class="form-check mb-3">
              {{ form.to_debtors }}
              <label class="form-check-label" for="{{ form.to_debtors.id_for_label }}">{{ form.to_debtors.label }}</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.house.id_for_label }}" class="form-label">{{ form.house.label }}</label>
                {{ form.house }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.section.id_for_label }}" class="form-label">{{ form.section.label }}</label>
                {{ form.section }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.floor.id_for_label }}" class="form-label">{{ form.floor.label }}</label>
                {{ form.floor }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.apartment.id_for_label }}" class="form-label">{{ form.apartment.label }}</label>
                {{ form.apartment }}
              </div>
            </div>
          </div>
          <div class="card-footer text-end">
            <a href="{% url 'users:message_list' %}" class="btn btn-secondary">Отменить</a>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-envelope-fill me-2"></i>Отправить
            </button>
          </div>
        </div>
      </form>
    </div>
  </section>
{% endblock content %}
{% block scripts %}
  {{ block.super }}
  <script>
    $(document).ready(function() {
      // --- Элементы формы ---
      const houseSelect = $('#{{ form.house.id_for_label }}');
      const sectionSelect = $('#{{ form.section.id_for_label }}');
      const floorSelect = $('#{{ form.floor.id_for_label }}');
      const apartmentSelect = $('#{{ form.apartment.id_for_label }}');

      // Функция сброса селекта
      // placeholderText - текст, который будет показан (например, "Всем..." или "Выберите дом")
      // disabled - нужно ли блокировать поле
      function resetSelect(select, placeholderText, disabled = true) {
        select.empty();
        // Добавляем опцию с пустым value - это и есть "Выбрать всех"
        select.append(new Option(placeholderText, ''));
        select.prop('disabled', disabled);
      }

      // Функция загрузки квартир
      function loadApartments(houseId, sectionId) {
        // Пока грузим, показываем текст загрузки
        resetSelect(apartmentSelect, 'Загрузка...', true);

        let url = `/api/v1/buildings/house/${houseId}/apartments`;

        // Если выбрана конкретная секция, добавляем фильтр
        if (sectionId) {
          url += `?section=${sectionId}`;
        }

        $.get(url, function(apartments) {
          // Очищаем и добавляем опцию "Всем..."
          apartmentSelect.empty().append(new Option('Всем...', ''));

          if (apartments.length > 0) {
            apartments.forEach(apt => {
              apartmentSelect.append(new Option(`кв.${apt.number}`, apt.id));
            });
            // Разблокируем поле, так как данные есть
            apartmentSelect.prop('disabled', false);
          } else {
            // Если квартир нет, блокируем и пишем сообщение
            apartmentSelect.empty().append(new Option('Нет квартир', ''));
            apartmentSelect.prop('disabled', true);
          }
        });
      }

      // --- Обработчик изменения ДОМА ---
      houseSelect.on('change', function() {
        const houseId = $(this).val();

        if (!houseId) {
          // Если выбрали "Всем..." (пустое значение) в поле Дома
          // Блокируем остальные поля, так как секции/этажи зависят от конкретного дома
          resetSelect(sectionSelect, 'Всем...', true);
          resetSelect(floorSelect, 'Всем...', true);
          resetSelect(apartmentSelect, 'Всем...', true);
          return;
        }

        // Сбрасываем зависимые поля, но ставим "Загрузка..."
        resetSelect(sectionSelect, 'Загрузка...', true);
        resetSelect(floorSelect, 'Загрузка...', true);
        resetSelect(apartmentSelect, 'Загрузка...', true);

        // 1. Загружаем СЕКЦИИ
        $.get(`/api/v1/buildings/house/${houseId}/sections`, function(sections) {
          sectionSelect.empty().append(new Option('Всем...', ''));
          sections.forEach(s => sectionSelect.append(new Option(s.name, s.id)));
          sectionSelect.prop('disabled', false);
        });

        // 2. Загружаем ЭТАЖИ
        $.get(`/api/v1/buildings/house/${houseId}/floors`, function(floors) {
          floorSelect.empty().append(new Option('Всем...', ''));
          floors.forEach(f => floorSelect.append(new Option(f.name, f.id)));
          floorSelect.prop('disabled', false);
        });

        // 3. Загружаем КВАРТИРЫ (сразу для всего дома)
        loadApartments(houseId, null);
      });

      // --- Обработчик изменения СЕКЦИИ ---
      sectionSelect.on('change', function() {
        const houseId = houseSelect.val();
        const sectionId = $(this).val();

        if (!houseId) return;

        // Перезагружаем квартиры.
        // Если sectionId пустой ("Всем..."), загрузятся все квартиры дома.
        loadApartments(houseId, sectionId);
      });

      // Этажи и Квартиры независимы друг от друга в контексте выбора,
      // поэтому на change этажа ничего перезагружать не нужно,
      // фильтрация произойдет на бэкенде.
    });
  </script>
{% endblock scripts %}
